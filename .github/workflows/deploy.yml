name: Deploy Next.js SSR Dashboard to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ›  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # OPTIONAL sanity check: make sure build works in CI before touching server
      - name: âœ… Install & Build (CI sanity check)
        run: |
          npm install --legacy-peer-deps
          npm run build

      # ğŸ“¦ Create tarball of the whole project EXCEPT junk
      - name: ğŸ“¦ Create Release Archive
        run: |
          tar \
            --exclude='./node_modules' \
            --exclude='./.git' \
            --exclude='.DS_Store' \
            -czvf dashboard.tar.gz . || true

      # ğŸš€ Upload build archive to EC2 using SSH KEY (not password)
      - name: ğŸš€ Upload Archive to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AWS_SSH_HOST }}
          username: ${{ secrets.AWS_SSH_USER }}
          port: ${{ secrets.AWS_SSH_PORT }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: "dashboard.tar.gz"
          target: "/home/admin7uniqver/"

      # ğŸ” SSH into EC2, deploy, install, build again there, restart PM2
      - name: ğŸ”„ Build & Restart App on EC2 via PM2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_SSH_HOST }}
          username: ${{ secrets.AWS_SSH_USER }}
          port: ${{ secrets.AWS_SSH_PORT }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            set -e

            echo "ğŸ“‚ cd into live dashboard dir"
            cd /home/admin7uniqver/7uniqueverfiy_admin

            echo "ğŸ›¡ Take backup before deploy"
            timestamp=$(date +%Y%m%d_%H%M%S)
            mkdir -p /home/admin7uniqver/deploy_backups_dashboard
            cp -r /home/admin7uniqver/7uniqueverfiy_admin /home/admin7uniqver/deploy_backups_dashboard/7uniqueverfiy_admin_$timestamp || true

            echo "ğŸ§¹ Clean old code (keep .env if you have it)"
            find . -mindepth 1 -maxdepth 1 \
              ! -name '.env' \
              ! -name 'node_modules' \
              -exec rm -rf {} +

            echo "ğŸ“¦ Extract new dashboard.tar.gz"
            tar -xzvf /home/admin7uniqver/dashboard.tar.gz -C .
            rm /home/admin7uniqver/dashboard.tar.gz

            echo "ğŸ“¦ Install deps on server"
            npm install --legacy-peer-deps

            echo "ğŸ— Rebuild Next.js on server (SSR build)"
            npm run build

            echo "ğŸ” Restart PM2 process for dashboard"
            pm2 restart next-dashboard-3001 || pm2 start ecosystem.config.js --name next-dashboard-3001

            echo "ğŸ’¾ Save PM2 startup"
            pm2 save

            echo "âœ… Dashboard deployed and PM2 restarted"
