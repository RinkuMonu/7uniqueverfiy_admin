name: Deploy Next.js SSR Dashboard to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v3

      - name: 🛠 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 1. Make sure code actually builds before touching server
      - name: ✅ Install & Build (CI sanity check)
        run: |
          npm install --legacy-peer-deps
          npm run build

      # 2. Pack repo to send to server
      - name: 📦 Create Release Archive
        run: |
          tar \
            --exclude='./node_modules' \
            --exclude='./.git' \
            --exclude='.DS_Store' \
            --exclude='./.env' \
            -czvf dashboard.tar.gz . || true

      # 3. Upload archive to server using SSH key (not password)
      - name: 🚀 Upload Archive to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AWS_SSH_HOST }}
          username: ${{ secrets.AWS_SSH_USER }}
          port: ${{ secrets.AWS_SSH_PORT }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: "dashboard.tar.gz"
          target: "/home/admin7uniqver/"

      # 4. SSH in, deploy code, build prod, run via PM2
      - name: 🔄 Build & Restart Dashboard on EC2 with PM2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_SSH_HOST }}
          username: ${{ secrets.AWS_SSH_USER }}
          port: ${{ secrets.AWS_SSH_PORT }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            set -e

            echo "📂 cd into live dashboard dir"
            cd /home/admin7uniqver/7uniqueverfiy_admin

            echo "🛡 Take backup before deploy"
            timestamp=$(date +%Y%m%d_%H%M%S)
            mkdir -p /home/admin7uniqver/deploy_backups_dashboard
            cp -r /home/admin7uniqver/7uniqueverfiy_admin /home/admin7uniqver/deploy_backups_dashboard/7uniqueverfiy_admin_$timestamp || true

            echo "🧹 Clean old code (keep .env and node_modules)"
            find . -mindepth 1 -maxdepth 1 \
              ! -name '.env' \
              ! -name 'node_modules' \
              -exec rm -rf {} +

            echo "📦 Extract new dashboard.tar.gz"
            tar -xzvf /home/admin7uniqver/dashboard.tar.gz -C .
            rm /home/admin7uniqver/dashboard.tar.gz

            echo "📦 Install deps on server"
            npm install --legacy-peer-deps

            echo "🏗 Build production Next.js"
            npm run build

            echo "🚀 (Re)start PM2 process 'dashboard-admin'"
            pm2 restart admin.7uniqueverfiy.com || pm2 start "npm run start" --name admin.7uniqueverfiy.com

            echo "💾 Save PM2 boot config"
            pm2 save

            echo "✅ Dashboard deployed and running under PM2 as 'dashboard-admin'"
